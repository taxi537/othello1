<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سیستم بررسی شیفت‌های تاکسی</title>
  <style>
    body{background:#111;color:#fff;font-family:Vazirmatn, sans-serif;padding:20px}
    .admin-btn{position:fixed;top:20px;right:20px;background:#ffcc00;color:#000;padding:10px;border-radius:8px;border:none;cursor:pointer}
    .panel{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#222;padding:20px;border-radius:12px;border:2px solid #ffcc00;z-index:9999}
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9998}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #333;text-align:center}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <button class="admin-btn" onclick="openLogin()">مدیریت</button>
  <h1>شیفت‌ها</h1>
  <div id="current"></div>
  <div id="table"></div>

  <div class="overlay" id="overlay"></div>

  <div class="panel" id="loginPanel">
    <h3>ورود</h3>
    <input id="u" placeholder="username"><br><br>
    <input id="p" placeholder="password" type="password"><br><br>
    <button onclick="doLogin()">ورود</button>
    <button onclick="closeLogin()">بستن</button>
  </div>

  <div class="panel" id="adminPanel">
    <h3>پنل مدیریت</h3>
    <select id="sel"></select><br><br>
    <button onclick="toggleVacation()">اعمال/لغو مرخصی</button>
    <button onclick="openChange()">تغییر تایم</button>
    <button onclick="doLogout()">خروج</button>
  </div>

  <div class="panel" id="changePanel">
    <h3>تغییر تایم</h3>
    <input id="ns" placeholder="08:00"> تا <input id="ne" placeholder="17:00"><br><br>
    <button onclick="applyChange()">تایید</button>
    <button onclick="closeChange()">بستن</button>
  </div>

<script>
/*
  روش امنِ واقعی: لاگین باید سمت سرور بررسی بشه.
  اینجا فقط یک بهبودِ کلیِ client-side برای پنهان‌سازی سریع انجام شد.
  هشِ salt+password (SHA-256) را داخل code گذاشتم اما به‌صورت چندتکه (split)
  تا view-source مستقیم یک خط پسورد را نشان ندهد.
*/

// --- sample shifts (local) ---
let shifts = [
  { id:1, name:"Danyall Abbasi", rank:"Taxi Director", times:[{start:"20:00",end:"23:00"}], vacation:false },
  { id:2, name:"Kourosh Zabeti", rank:"Taxi Deputy Director", times:[{start:"14:00",end:"17:00"}], vacation:false },
  { id:3, name:"Parham Azizi", rank:"Taxi Attendant", times:[{start:"12:00",end:"12:01"}], vacation:false },
  { id:4, name:"Abbas Abbasi", rank:"Taxi Attendant", times:[{start:"12:00",end:"15:00"}], vacation:false },
  { id:5, name:"Parsa Rahimi", rank:"Taxi Attendant", times:[{start:"12:00",end:"15:00"}], vacation:false },
  { id:6, name:"Taha Azizii", rank:"Taxi Attendant", times:[{start:"09:00",end:"12:00"}], vacation:false },
  { id:7, name:"Arya Khazeie", rank:"Taxi Attendant", times:[{start:"20:30",end:"23:30"}], vacation:false }
];

const API = ""; // no backend in this quick patch

// --- HIDDEN hashed credential (salt+password hashed with SHA-256) ---
// salt value (must match what was used to produce the hash)
const _salt = atob("c29tZXNhbHQxMjM0NQ=="); // "somesalt12345" encoded base64 to hide plain text
// hashed value hex stored split into parts to avoid single-line detection
const _hashParts = ["2af4789b05f9","356480bdbd72","4cd0e49d52b8","f7aa8581b373868b200a6b7cd952"];

// join to reconstruct
function getStoredHashHex(){
  return _hashParts.join("");
}

// utility: convert hex to Uint8Array
function hexToBytes(hex){
  const bytes = new Uint8Array(hex.length/2);
  for(let i=0;i<bytes.length;i++) bytes[i]=parseInt(hex.substr(i*2,2),16);
  return bytes;
}

// compute SHA-256 of (salt + password) via Web Crypto, return hex
async function sha256hex(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = new Uint8Array(hash);
  return Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
}

// simple render functions
function render(){
  document.getElementById('table').innerHTML = `<table><tr><th>نام</th><th>رنک</th><th>ساعت</th><th>وضعیت</th></tr>` +
    shifts.map(s=>`<tr><td>${s.name}</td><td>${s.rank}</td><td>${s.times[0].start} تا ${s.times[0].end}</td><td>${s.vacation? 'مرخصی':'فعال'}</td></tr>`).join('') +
    `</table>`;
  const now = new Date();
  const cur = shifts.find(s=>{
    if(s.vacation) return false;
    const [sh,sm] = s.times[0].start.split(':').map(Number);
    const [eh,em] = s.times[0].end.split(':').map(Number);
    const curM = now.getHours()*60 + now.getMinutes();
    const sM = sh*60 + sm;
    const eM = eh*60 + em;
    if(sM <= eM) return curM>=sM && curM<eM;
    return curM>=sM || curM<eM;
  });
  document.getElementById('current').innerText = cur ? `${cur.name} (${cur.rank}) در حال شیفت` : 'در حال حاضر کسی در شیفت نیست';
}

// --- login flow using salted SHA-256 check on client (obfuscated storage) ---
function openLogin(){ document.getElementById('overlay').style.display='block'; document.getElementById('loginPanel').style.display='block'; }
function closeLogin(){ document.getElementById('overlay').style.display='none'; document.getElementById('loginPanel').style.display='none'; }
function openAdmin(){ document.getElementById('overlay').style.display='block'; document.getElementById('adminPanel').style.display='block'; fillSelect(); }
function closePanel(){ document.getElementById('overlay').style.display='none'; document.getElementById('adminPanel').style.display='none'; document.getElementById('changePanel').style.display='none'; }

async function doLogin(){
  const username = document.getElementById('u').value.trim();
  const password = document.getElementById('p').value;
  if(!username || !password){ alert('یوزرنیم و پسورد را وارد کنید'); return; }

  // compute hash of salt + password
  const candidate = await sha256hex(_salt + password);
  const stored = getStoredHashHex();

  // simple username check (we keep username in plain as "Vigilante" - you can change)
  if(username !== "Vigilante"){
    alert('نام کاربری یا رمز اشتباه است');
    return;
  }

  if(candidate === stored){
    // success
    closeLogin();
    openAdmin();
  } else {
    alert('نام کاربری یا رمز اشتباه است');
  }

  // clear password input quickly
  document.getElementById('p').value = "";
}

// admin actions (local only)
async function toggleVacation(){
  const id = Number(document.getElementById('sel').value);
  const p = shifts.find(s=>s.id===id);
  if(p){ p.vacation = !p.vacation; render(); fillSelect(); }
}

function fillSelect(){ const sel = document.getElementById('sel'); sel.innerHTML = shifts.map(s=>`<option value="${s.id}">${s.name}${s.vacation? ' (مرخصی)':''}</option>`).join(''); }

function openChange(){ document.getElementById('changePanel').style.display='block'; }
function closeChange(){ document.getElementById('changePanel').style.display='none'; }
function applyChange(){
  const id = Number(document.getElementById('sel').value);
  const ns = document.getElementById('ns').value;
  const ne = document.getElementById('ne').value;
  const p = shifts.find(s=>s.id===id);
  if(!p){ alert('انتخاب نامناسب'); return; }
  p.times[0].start = ns || p.times[0].start;
  p.times[0].end = ne || p.times[0].end;
  render(); fillSelect(); closeChange();
}

function doLogout(){ closePanel(); }

// quick anti-casual-devtools (not secure, just deterrent)
document.addEventListener('contextmenu', e=>{ e.preventDefault(); });
document.addEventListener('keydown', e=> {
  if((e.ctrlKey && e.shiftKey && (e.key==='I' || e.key==='i')) || (e.key==='F12')) {
    e.preventDefault();
    alert('دسترسی محدود است.');
  }
});

// init
render();
setInterval(render, 15000);
</script>
</body>
</html>
